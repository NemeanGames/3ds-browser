<!DOCTYPE html>
<!-- 3DS Family Hub — ES5 single-file app
     Features: roles (owner, operator, member, guest), room create=owner,
     profanity toggle, whiteboard PNG-to-chat, server list, games stubs,
     3DS pointer fix, inline forms, aria-live. -->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3DS Family Hub</title>
  <style>
    body{margin:0;padding:0;font-family:sans-serif;background:#f5f5f5;color:#111}
    .header{background:#333;color:#fff;padding:8px;display:flex;flex-wrap:wrap;align-items:center}
    .header h1{margin:4px 8px;font-size:18px;flex-grow:1}
    .user-controls{display:flex;flex-wrap:wrap;align-items:center}
    .user-controls input[type="text"],.user-controls input[type="password"],.user-controls input[type="color"]{margin:2px;padding:2px;font-size:14px}
    .user-controls button{margin:2px;padding:4px 8px;font-size:14px}
    .toggle-group label{margin-left:8px;font-size:12px;color:#fff}
    .notice{font-size:12px;color:#c33;margin-left:8px}
    .tabs{display:flex;border-bottom:1px solid #ccc;background:#eee}
    .tabs button{flex:1;padding:8px;border:none;background:#ddd;font-size:14px}
    .tabs button.active{background:#fff;font-weight:bold}
    .tab-content{display:none;padding:8px}
    .tab-content.active{display:block;background:#fff}
    #chat-messages{height:200px;overflow-y:auto;border:1px solid #ccc;padding:4px;background:#fafafa;font-size:12px}
    #chat-messages .msg{margin:2px 0;padding:2px}
    #members-list{margin-top:4px;font-size:12px}
    .game-grid{display:flex;flex-wrap:wrap;margin-top:8px}
    .game-card{width:130px;border:1px solid #ccc;border-radius:4px;margin:4px;padding:4px;text-align:center;background:#fafafa}
    .game-card img{width:64px;height:64px;object-fit:cover}
    .game-card button{display:block;margin:4px auto;padding:4px}
    #calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
    #calendar div{border:1px solid #ccc;padding:4px;text-align:center;font-size:12px;height:40px;position:relative}
    #calendar div.event{background:#cdeffc}
    #canvas-wrapper{position:relative;border:1px solid #ccc;width:100%;height:240px;touch-action:none;background:#fff}
    #whiteboard-canvas{width:100%;height:100%;background:#fff;display:block}
    #wb-toolbar{margin-top:4px;display:flex;flex-wrap:wrap}
    #wb-toolbar button,#wb-toolbar input[type="color"],#wb-toolbar input[type="number"]{margin:2px;padding:4px}
    .hidden{display:none}
    .compat-3ds body{font-size:16px}
    .compat-3ds .user-controls input,.compat-3ds .user-controls button{font-size:16px;padding:6px}
    .compat-3ds .tabs button{font-size:16px}
    .compat-3ds #whiteboard-canvas{image-rendering:pixelated}
  </style>
</head>
<body>
  <div class="header">
    <h1>3DS Family Hub</h1>
    <div class="user-controls">
      <label for="username-input" style="color:#fff;">Name</label>
      <input id="username-input" type="text" placeholder="Your name" aria-label="Your name" />
      <label for="user-color" style="color:#fff;">Color</label>
      <input id="user-color" type="color" value="#008000" aria-label="Choose color" />
      <button id="save-user" type="button">Save</button>
      <label for="room-input" style="color:#fff;">Room</label>
      <input id="room-input" type="text" placeholder="room-name" aria-label="Room name" />
      <input id="room-pass" type="password" placeholder="password (optional)" aria-label="Room password" />
      <button id="join-room" type="button">Join</button>
      <button id="create-room" type="button">Create</button>
      <button id="purge-chat" type="button" class="hidden">Purge</button>
      <button id="delete-room" type="button" class="hidden">Delete</button>
      <label class="toggle-group" style="color:#fff;">Profanity
        <input type="checkbox" id="toggle-profanity" checked="checked" />
      </label>
      <span id="status-msg" class="notice" aria-live="polite"></span>
    </div>
  </div>
  <div class="tabs">
    <button id="tab-chat" class="active">Chat</button>
    <button id="tab-games">Games</button>
    <button id="tab-calendar">Calendar</button>
    <button id="tab-notes">Notes</button>
    <button id="tab-whiteboard">Whiteboard</button>
    <button id="tab-rooms">Rooms</button>
  </div>

  <div id="panel-chat" class="tab-content active" role="tabpanel" aria-labelledby="tab-chat">
    <div id="chat-messages" aria-live="polite"></div>
    <input id="chat-input" type="text" placeholder="Type a message" maxlength="500" aria-label="Message" style="width:calc(100% - 60px);" />
    <button id="send-message" type="button" style="width:50px;">Send</button>
    <div id="members-list" aria-live="polite"></div>
  </div>

  <div id="panel-games" class="tab-content" role="tabpanel" aria-labelledby="tab-games">
    <div class="game-grid" id="game-grid">
      <div class="game-card">
        <img src="https://via.placeholder.com/64?text=TTT" alt="Tic Tac Toe" />
        <strong>Tic Tac Toe</strong>
        <button class="game-local" data-game="tictactoe">Local Play</button>
        <button class="game-challenge" data-game="tictactoe">Challenge</button>
      </div>
      <div class="game-card">
        <img src="https://via.placeholder.com/64?text=RPS" alt="Rock Paper Scissors" />
        <strong>Rock Paper Scissors</strong>
        <button class="game-local" data-game="rps">Local Play</button>
        <button class="game-challenge" data-game="rps">Challenge</button>
      </div>
    </div>
    <div id="game-area"></div>
  </div>

  <div id="panel-calendar" class="tab-content" role="tabpanel" aria-labelledby="tab-calendar">
    <div id="calendar-controls" style="margin-bottom:4px;">
      <button id="cal-prev" type="button">&lt;</button>
      <span id="cal-month-label">Month</span>
      <button id="cal-next" type="button">&gt;</button>
    </div>
    <div id="calendar"></div>
    <div id="cal-editor" class="hidden" style="margin-top:8px;">
      <input id="cal-title" type="text" placeholder="Event title" aria-label="Event title" />
      <input id="cal-date" type="date" aria-label="Date" />
      <button id="cal-save" type="button">Save</button>
      <button id="cal-cancel" type="button">Cancel</button>
    </div>
  </div>

  <div id="panel-notes" class="tab-content" role="tabpanel" aria-labelledby="tab-notes">
    <textarea id="notes-area" style="width:100%;height:150px;" aria-label="Notes"></textarea>
    <button id="notes-save" type="button">Save Notes</button>
  </div>

  <div id="panel-whiteboard" class="tab-content" role="tabpanel" aria-labelledby="tab-whiteboard">
    <div id="canvas-wrapper">
      <canvas id="whiteboard-canvas" width="320" height="240" aria-label="Drawing canvas"></canvas>
    </div>
    <div id="wb-toolbar">
      <input id="wb-color" type="color" value="#000000" aria-label="Brush color" />
      <input id="wb-size" type="number" min="1" max="20" value="2" aria-label="Brush size" />
      <button id="wb-pencil" type="button">Pencil</button>
      <button id="wb-eraser" type="button">Eraser</button>
      <button id="wb-clear" type="button">Clear</button>
      <button id="wb-save-file" type="button">Save</button>
      <button id="wb-save-chat" type="button">Save to chat</button>
    </div>
  </div>

  <div id="panel-rooms" class="tab-content" role="tabpanel" aria-labelledby="tab-rooms">
    <div id="rooms-list" aria-live="polite">Loading rooms…</div>
  </div>

  <script>
  (function(){
    'use strict';
    function $(id){return document.getElementById(id);}

    // Firebase setup
    var firebaseConfig = /* FIREBASE_CONFIG */ {};
    var app=null, auth=null, db=null, storage=null;
    if(typeof firebase!=='undefined' && firebaseConfig && firebaseConfig.apiKey){
      app=firebase.initializeApp(firebaseConfig);
      auth=firebase.auth();
      db=firebase.firestore();
      storage=firebase.storage();
    }

    // Tabs
    var tabs=['chat','games','calendar','notes','whiteboard','rooms'];
    tabs.forEach(function(n){
      var b=$('tab-'+n), p=$('panel-'+n);
      b.addEventListener('click',function(){
        tabs.forEach(function(t){ $('tab-'+t).classList.remove('active'); $('panel-'+t).classList.remove('active'); });
        b.classList.add('active'); p.classList.add('active');
        if(n==='whiteboard') fitCanvas();
      },false);
    });

    function is3DS(){ var ua=navigator.userAgent||''; return ua.indexOf('Nintendo 3DS')!==-1 || ua.indexOf('Nintendo DSi')!==-1; }
    if(is3DS()){ document.body.classList.add('compat-3ds'); }

    // Profile
    var currentUserName='', currentColor='#008000';
    function loadProfile(){
      try{
        var n=localStorage.getItem('username'); if(n){ currentUserName=n; $('username-input').value=n; }
        var c=localStorage.getItem('color'); if(c){ currentColor=c; $('user-color').value=c; }
        var r=localStorage.getItem('room'); if(r){ $('room-input').value=r; }
      }catch(e){}
    } loadProfile();
    $('save-user').onclick=function(){
      currentUserName=$('username-input').value.trim()||'Guest';
      currentColor=$('user-color').value;
      try{ localStorage.setItem('username',currentUserName); localStorage.setItem('color',currentColor);}catch(e){}
      showStatus('Profile saved');
    };

    // Status
    var statusTimeout=null;
    function showStatus(msg){ $('status-msg').textContent=msg; clearTimeout(statusTimeout); statusTimeout=setTimeout(function(){ $('status-msg').textContent=''; },3000); }

    // Room + roles
    var currentRoom=null, roomPassword='', roomCfg={profanity:true,shareToDiscord:false};
    var myRole='guest', isOwner=false, isOperator=false;
    var unsubscribeChat=null, unsubscribeMembers=null, unsubscribeRooms=null;

    $('join-room').onclick=function(){ enterRoom(false); };
    $('create-room').onclick=function(){ enterRoom(true); };

    function simpleHash(str){ var h=0; for(var i=0;i<str.length;i++){ var ch=str.charCodeAt(i); h=((h<<5)-h)+ch; h|=0; } return ''+h; }

    function enterRoom(create){
      var name=$('room-input').value.trim();
      var pass=$('room-pass').value.trim();
      if(!name){ showStatus('Room name required'); return; }
      if(!db){ showStatus('Database not ready'); return; }
      currentRoom=name; roomPassword=pass;
      try{ localStorage.setItem('room',name);}catch(e){}
      var metaRef=db.collection('rooms').doc(name).collection('_meta').doc('config');

      if(create){
        var myUid=(auth&&auth.currentUser)?auth.currentUser.uid:null;
        var salt=''+Date.now(), passHash=pass?simpleHash(pass+salt):'';
        metaRef.set({created:Date.now(),salt:salt,passHash:passHash,owner:myUid,profanity:true},{merge:true})
        .then(function(){
          if(myUid){
            return db.collection('rooms').doc(name).collection('members').doc(myUid)
              .set({name:currentUserName||'Owner',color:currentColor||'#008000',role:'owner',since:Date.now()},{merge:true});
          }
        }).then(onEnteredRoom).catch(function(e){ showStatus(e.message); });
      }else{
        metaRef.get().then(function(doc){
          if(!doc.exists){ showStatus('Room does not exist'); return; }
          var data=doc.data()||{};
          if(data.passHash){
            var test=simpleHash(pass+data.salt);
            if(test!==data.passHash){ showStatus('Wrong password'); return; }
          }
          ensureMemberDoc();
          onEnteredRoom();
        }).catch(function(e){ showStatus(e.message); });
      }
    }

    function ensureMemberDoc(){
      if(!db||!currentRoom||!auth||!auth.currentUser) return;
      var uid=auth.currentUser.uid;
      var ref=db.collection('rooms').doc(currentRoom).collection('members').doc(uid);
      ref.get().then(function(s){ if(!s.exists){ ref.set({name:currentUserName||'Guest',color:currentColor||'#008000',role:'member',since:Date.now()}); }});
    }

    function onEnteredRoom(){
      listenMyRole();
      loadRoomCfg();
      listenChat();
      listenMembers();
      listenRooms();
      showStatus('Entered room '+currentRoom);
    }

    function listenMyRole(){
      if(!db||!currentRoom||!auth||!auth.currentUser) return;
      var uid=auth.currentUser.uid;
      db.collection('rooms').doc(currentRoom).collection('members').doc(uid)
        .onSnapshot(function(s){
          myRole = s.exists ? (s.data().role || 'member') : 'guest';
          isOwner = (myRole==='owner');
          isOperator = (myRole==='operator');
          $('purge-chat').classList.toggle('hidden', !isOwner);
          $('delete-room').classList.toggle('hidden', !isOwner);
          $('toggle-profanity').disabled = !isOwner;
        });
    }

    function loadRoomCfg(){
      if(!db||!currentRoom) return;
      db.collection('rooms').doc(currentRoom).collection('_meta').doc('config')
        .onSnapshot(function(s){ if(s.exists){ roomCfg=s.data()||roomCfg; $('toggle-profanity').checked=!!roomCfg.profanity; }});
    }

    $('toggle-profanity').addEventListener('change', function(){
      if(!db||!currentRoom) return;
      if(!isOwner){ this.checked=!!roomCfg.profanity; showStatus('Owner only'); return; }
      db.collection('rooms').doc(currentRoom).collection('_meta').doc('config').set({profanity:this.checked},{merge:true});
    }, false);

    // Chat
    var lastSend=0;
    $('send-message').onclick=sendMessage;
    $('chat-input').addEventListener('keypress',function(e){ if(e.keyCode===13){ e.preventDefault(); sendMessage(); }},false);

    function sanitize(t){ return (t||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function pad2(n){ return (n<10?'0':'')+n; }
    function applyProfanityFilter(text){
      var bad=['fuck','shit','damn','bitch','nigger','faggot','retard','cunt','asshole','bastard'];
      var out=text||''; for(var i=0;i<bad.length;i++){ var re=new RegExp(bad[i],'gi'); out=out.replace(re,'***'); } return out;
    }

    function sendMessage(){
      if(!db||!currentRoom){ showStatus('Join a room'); return; }
      if(myRole==='guest'){ showStatus('Guests cannot chat'); return; }
      var now=Date.now(); if(now-lastSend<3000){ showStatus('Too fast'); return; }
      var text=$('chat-input').value.trim(); if(!text) return; if(text.length>500){ showStatus('Too long'); return; }
      var safeText = roomCfg.profanity ? applyProfanityFilter(text) : text;
      var msg={ user:currentUserName||'Guest', color:currentColor, text:safeText, rawText:text, tsMs:now, uid: (auth&&auth.currentUser)?auth.currentUser.uid:null };
      db.collection('rooms').doc(currentRoom).collection('messages').add(msg).then(function(){ $('chat-input').value=''; lastSend=now; });
    }

    function listenChat(){
      if(unsubscribeChat){unsubscribeChat();unsubscribeChat=null;}
      if(!db||!currentRoom) return;
      var col=db.collection('rooms').doc(currentRoom).collection('messages').orderBy('tsMs');
      unsubscribeChat = col.onSnapshot(function(snapshot){
        var container=$('chat-messages'); container.innerHTML='';
        snapshot.forEach(function(doc){
          var m=doc.data(); var div=document.createElement('div'); div.className='msg';
          var time=''; if(m.tsMs){ var d=new Date(m.tsMs); time='['+pad2(d.getHours())+':'+pad2(d.getMinutes())+':'+pad2(d.getSeconds())+'] '; }
          var name=document.createElement('span'); name.style.color=m.color||'#000'; name.textContent=(m.user||'')+': ';
          div.textContent=time; div.appendChild(name);
          var text=document.createElement('span'); text.innerHTML=sanitize(m.text||''); div.appendChild(text);
          container.appendChild(div);
        });
        container.scrollTop=container.scrollHeight;
      });
    }

    // Members / Roles UI
    function listenMembers(){
      if(unsubscribeMembers){unsubscribeMembers();unsubscribeMembers=null;}
      if(!db||!currentRoom) return;
      var myUid=(auth&&auth.currentUser)?auth.currentUser.uid:null;
      var col=db.collection('rooms').doc(currentRoom).collection('members');
      unsubscribeMembers = col.onSnapshot(function(snap){
        var list=$('members-list'); list.innerHTML='';
        snap.forEach(function(doc){
          var d=doc.data()||{}, uid=doc.id, r=d.role||'member';
          var row=document.createElement('div'); row.style.margin='2px 0';
          var nm=document.createElement('strong'); nm.textContent=(d.name||'Anon')+' '; nm.style.color=d.color||'#000'; row.appendChild(nm);
          var badge=document.createElement('span'); badge.textContent='['+r+'] '; row.appendChild(badge);

          if(isOwner && uid!==myUid){
            var sel=document.createElement('select');
            sel.innerHTML='<option>owner</option><option>operator</option><option>member</option><option>guest</option>';
            sel.value=r; sel.onchange=function(){ setRole(uid, sel.value); };
            row.appendChild(sel);
          } else if(isOperator && uid!==myUid && r!=='owner'){
            var sel2=document.createElement('select');
            sel2.innerHTML='<option>member</option><option>guest</option>';
            sel2.value=(r==='member'||r==='guest')?r:'member';
            sel2.onchange=function(){ setRole(uid, sel2.value); };
            row.appendChild(sel2);
          }
          list.appendChild(row);
        });
      });
    }

    function setRole(uid, role){
      db.collection('rooms').doc(currentRoom).collection('members').doc(uid)
        .update({ role: role }).then(function(){ showStatus('Role updated'); }).catch(function(){ showStatus('Denied'); });
    }

    // Rooms list (server list style)
    function listenRooms(){
      if(unsubscribeRooms){unsubscribeRooms();unsubscribeRooms=null;}
      if(!db) return;
      unsubscribeRooms = db.collection('rooms_index').orderBy('memberCount','desc').limit(30)
        .onSnapshot(function(snapshot){
          var rl=$('rooms-list'); rl.innerHTML='';
          snapshot.forEach(function(doc){
            var data=doc.data()||{}; var roomName=data.roomId||doc.id;
            var btn=document.createElement('button'); btn.textContent=roomName+' ('+(data.memberCount||0)+')';
            btn.onclick=function(){ $('room-input').value=roomName; $('room-pass').value=''; enterRoom(false); };
            rl.appendChild(btn);
          });
        });
    }

    // Commands (owner only) via functions
    function postCommand(type){
      if(!db||!currentRoom){ showStatus('Join a room'); return; }
      db.collection('rooms').doc(currentRoom).collection('commands').add({
        type:type, uid:(auth&&auth.currentUser)?auth.currentUser.uid:null, ts:Date.now()
      }).then(function(){ showStatus(type+' requested'); });
    }
    $('purge-chat').onclick=function(){ if(confirm('Delete all messages?')) postCommand('purge'); };
    $('delete-room').onclick=function(){ if(confirm('Delete room?')) postCommand('deleteRoom'); };

    // Calendar minimal
    var currentDate=new Date();
    function pad2(n){return (n<10?'0':'')+n;}
    function renderCalendar(){
      var y=currentDate.getFullYear(), m=currentDate.getMonth();
      var first=new Date(y,m,1), last=new Date(y,m+1,0);
      $('cal-month-label').textContent=y+'-'+pad2(m+1);
      var grid=$('calendar'); grid.innerHTML='';
      for(var i=0;i<first.getDay();i++){ var c=document.createElement('div'); grid.appendChild(c); }
      for(var d=1; d<=last.getDate(); d++){
        (function(day){
          var c=document.createElement('div'); c.textContent=day;
          var iso=y+'-'+pad2(m+1)+'-'+pad2(day); c.setAttribute('data-date',iso);
          c.onclick=function(){ openCalEditor(iso); };
          grid.appendChild(c);
        })(d);
      }
    }
    $('cal-prev').onclick=function(){ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); };
    $('cal-next').onclick=function(){ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); };
    function openCalEditor(dateStr){ $('cal-editor').classList.remove('hidden'); $('cal-date').value=dateStr; $('cal-title').value=''; }
    $('cal-cancel').onclick=function(){ $('cal-editor').classList.add('hidden'); };
    $('cal-save').onclick=function(){
      var title=$('cal-title').value.trim(), dateStr=$('cal-date').value;
      if(!title||!dateStr){ showStatus('Missing title or date'); return; }
      if(!db||!currentRoom){ showStatus('Database not ready'); return; }
      if(myRole==='guest'){ showStatus('Guests cannot create events'); return; }
      var ts=new Date(dateStr).getTime();
      var ev={title:title,startTs:ts,endTs:null,color:currentColor,createdBy:currentUserName,version:1,visibility:'public'};
      db.collection('rooms').doc(currentRoom).collection('calendar').add(ev).then(function(){ $('cal-editor').classList.add('hidden'); showStatus('Event added'); });
    };
    renderCalendar();

    // Notes
    $('notes-save').onclick=function(){
      var content=$('notes-area').value;
      if(!db||!currentRoom){ try{localStorage.setItem('notes-'+currentRoom,content); showStatus('Notes saved locally');}catch(e){} return; }
      db.collection('rooms').doc(currentRoom).collection('_meta').doc('notes')
        .set({text:content,updated:Date.now()},{merge:true}).then(function(){ showStatus('Notes saved'); });
    };

    // Whiteboard
    var canvas=$('whiteboard-canvas'), ctx=canvas.getContext('2d');
    ctx.lineJoin='round'; ctx.lineCap='round';
    var drawing=false, tool='pencil', brushSize=parseInt($('wb-size').value,10), color=$('wb-color').value;

    function fitCanvas(){ var r=canvas.parentNode.getBoundingClientRect(); var w=Math.round(r.width), h=Math.round(r.height); if(canvas.width!==w||canvas.height!==h){ canvas.width=w; canvas.height=h; } }
    function getPoint(e){ var r=canvas.getBoundingClientRect(); var sx=canvas.width/r.width, sy=canvas.height/r.height; return {x:(e.clientX-r.left)*sx,y:(e.clientY-r.top)*sy}; }
    window.addEventListener('resize',fitCanvas); fitCanvas();

    canvas.addEventListener('mousedown',startDraw,false);
    canvas.addEventListener('touchstart',function(e){e.preventDefault();startDraw(e.touches[0]);},false);
    canvas.addEventListener('mousemove',drawMove,false);
    canvas.addEventListener('touchmove',function(e){e.preventDefault();drawMove(e.touches[0]);},false);
    canvas.addEventListener('mouseup',endDraw,false);
    canvas.addEventListener('mouseleave',endDraw,false);
    canvas.addEventListener('touchend',function(e){e.preventDefault();endDraw();},false);
    canvas.addEventListener('touchcancel',function(e){e.preventDefault();endDraw();},false);

    function startDraw(e){ drawing=true; ctx.beginPath(); var p=getPoint(e); ctx.moveTo(p.x,p.y); }
    function drawMove(e){ if(!drawing) return; var p=getPoint(e); ctx.lineWidth=brushSize; ctx.strokeStyle=(tool==='eraser')?'#ffffff':color; ctx.lineTo(p.x,p.y); ctx.stroke(); }
    function endDraw(){ if(!drawing) return; drawing=false; ctx.closePath(); }
    $('wb-color').oninput=function(){ color=this.value; };
    $('wb-size').oninput=function(){ brushSize=parseInt(this.value,10)||1; };
    $('wb-pencil').onclick=function(){ tool='pencil'; };
    $('wb-eraser').onclick=function(){ tool='eraser'; };
    $('wb-clear').onclick=function(){ ctx.clearRect(0,0,canvas.width,canvas.height); };
    $('wb-save-file').onclick=function(){ var dataUrl=canvas.toDataURL('image/png'); var a=document.createElement('a'); a.href=dataUrl; a.download='drawing.png'; a.click(); };
    $('wb-save-chat').onclick=function(){ if(myRole==='guest'){ showStatus('Guests cannot upload'); return; } saveDrawingToChat(); };

    function saveDrawingToChat(){
      var dataUrl=canvas.toDataURL('image/png');
      if(!storage){ $('chat-input').value=dataUrl; sendMessage(); return; }
      var ref=storage.ref().child('drawings/'+(currentRoom||'default')+'/wb-'+Date.now()+'.png');
      ref.putString(dataUrl,'data_url').then(function(s){ return s.ref.getDownloadURL(); })
        .then(function(url){ $('chat-input').value=url; sendMessage(); showStatus('Drawing uploaded'); })
        .catch(function(e){ showStatus('Upload failed'); });
    }

    // Games
    var gameArea=$('game-area');
    function startGameLocal(name){ if(name==='tictactoe'){ renderTicTacToe(); } else if(name==='rps'){ renderRPS(); } }
    document.querySelectorAll('.game-local').forEach(function(b){ b.addEventListener('click',function(){ startGameLocal(this.getAttribute('data-game')); }); });
    document.querySelectorAll('.game-challenge').forEach(function(b){ b.addEventListener('click',function(){
      if(!db||!currentRoom){ showStatus('Join a room'); return; }
      db.collection('rooms').doc(currentRoom).collection('challenges').add({ game:this.getAttribute('data-game'), fromUid:(auth&&auth.currentUser)?auth.currentUser.uid:null, fromName:currentUserName||'Guest', created:Date.now(), status:'pending' });
      showStatus('Challenge sent');
    }); });

    function renderTicTacToe(){
      gameArea.innerHTML=''; var board=document.createElement('table'); board.style.margin='8px auto'; board.style.borderCollapse='collapse';
      var cells=[]; for(var i=0;i<3;i++){ var tr=document.createElement('tr'); for(var j=0;j<3;j++){ (function(idx){
        var td=document.createElement('td'); td.style.border='1px solid #333'; td.style.width='40px'; td.style.height='40px'; td.style.textAlign='center'; td.style.fontSize='24px'; td.textContent='';
        td.onclick=function(){ if(td.textContent) return; var turn=(countMarks(cells)%2===0)?'X':'O'; td.textContent=turn; if(checkWinner()){ showStatus('Winner: '+turn); }};
        cells.push(td); tr.appendChild(td);
      })(i*3+j);} board.appendChild(tr); }
      function countMarks(a){ var c=0; for(var k=0;k<a.length;k++){ if(a[k].textContent) c++; } return c; }
      function checkWinner(){ var w=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]]; for(var c=0;c<w.length;c++){ var A=cells[w[c][0]].textContent,B=cells[w[c][1]].textContent,C=cells[w[c][2]].textContent; if(A&&A===B&&A===C) return true; } return false; }
      gameArea.appendChild(board);
    }
    function renderRPS(){
      gameArea.innerHTML=''; var choices=['Rock','Paper','Scissors']; var status=document.createElement('div'); status.textContent='Choose'; status.style.marginBottom='4px'; gameArea.appendChild(status);
      choices.forEach(function(choice){ var btn=document.createElement('button'); btn.textContent=choice; btn.onclick=function(){ var ai=Math.floor(Math.random()*3); var aiC=choices[ai]; var res=getRes(choice,aiC); status.textContent='You: '+choice+' vs AI: '+aiC+' → '+res; }; gameArea.appendChild(btn); });
      function getRes(p,ai){ if(p===ai) return 'Tie'; if((p==='Rock'&&ai==='Scissors')||(p==='Paper'&&ai==='Rock')||(p==='Scissors'&&ai==='Paper')) return 'You win'; return 'You lose'; }
    }

  })();
  </script>
</body>
</html>
