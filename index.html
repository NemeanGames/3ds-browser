<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>3DS Family Hub</title>
<style>
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#fafafa;color:#111;}
.container{max-width:760px;margin:0 auto;padding:8px;}
header{display:flex;justify-content:space-between;align-items:center;background:#333;color:#fff;padding:6px;border-radius:4px;}
.brand{font-weight:700;}
.user-bar{font-size:13px;}
.user-bar span{margin-right:6px;}
nav{display:flex;margin-top:6px;}
nav button{flex:1;padding:8px;border:1px solid #ccc;background:#fff;font-size:14px;cursor:pointer;}
nav button.active{background:#eee;border-color:#999;}
main{border:1px solid #ddd;background:#fff;padding:8px;margin-top:6px;min-height:320px;}
section{display:none;}
section.active{display:block;}
#messages{list-style:none;padding:0;margin:0;max-height:160px;overflow-y:auto;border:1px solid #eee;padding:4px;font-size:13px;}
.controls{margin-top:6px;display:flex;}
.controls input{flex:1;padding:6px;font-size:14px;border:1px solid #ccc;border-radius:3px;}
.controls button{padding:6px 10px;margin-left:4px;cursor:pointer;}
small{font-size:12px;color:#666;}
#tictactoe-board td{width:40px;height:40px;border:1px solid #ccc;text-align:center;font-size:24px;cursor:pointer;}
#calendar-table{border-collapse:collapse;width:100%;}
#calendar-table td{border:1px solid #ccc;padding:4px;min-height:50px;vertical-align:top;font-size:12px;}
.event{background:#ffeb3b;color:#000;border-radius:3px;padding:1px 2px;margin-top:2px;display:block;font-size:10px;}
textarea{width:100%;height:200px;}
#whiteboard-canvas{border:1px solid #ccc;width:100%;height:300px;background:#fff;}
</style>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
<div class="container">
<header>
<div class="brand">3DS Family Hub</div>
<div class="user-bar" id="user-bar" style="display:none;">
<span id="display-user"></span>
<span id="color-swatch" style="width:16px;height:16px;border:1px solid #444;display:inline-block;"></span>
<button id="change-user" style="margin-left:6px;">Change</button>
</div>
</header>
<nav>
<button data-target="chat" class="active">Chat</button>
<button data-target="games">Games</button>
<button data-target="calendar">Calendar</button>
<button data-target="notes">Notes</button>
<button data-target="whiteboard">Whiteboard</button>
</nav>
<main>
<section id="chat" class="active">
<ul id="messages"></ul>
<div class="controls">
<input id="chat-input" type="text" placeholder="Type a message"/>
<button id="send-btn">Send</button>
</div>
<small>Room: <span id="room-id">family-room</span></small>
</section>
<section id="games">
<h3>Tic-Tac-Toe</h3>
<table id="tictactoe-board"></table>
<p id="tic-status"></p>
<h3>Rock Paper Scissors</h3>
<div id="rps-area">
<button class="rps-btn" data-choice="rock">Rock</button>
<button class="rps-btn" data-choice="paper">Paper</button>
<button class="rps-btn" data-choice="scissors">Scissors</button>
<p id="rps-result"></p>
</div>
</section>
<section id="calendar">
<div style="display:flex;justify-content:space-between;align-items:center;">
<button id="prev-month">Prev</button>
<span id="cal-title"></span>
<button id="next-month">Next</button>
</div>
<table id="calendar-table"></table>
</section>
<section id="notes">
<textarea id="notepad"></textarea>
<div style="margin-top:6px;">
<button id="save-note">Save</button>
<button id="load-note">Load</button>
</div>
</section>
<section id="whiteboard">
<canvas id="whiteboard-canvas" width="600" height="300"></canvas>
<div style="margin-top:6px;">
<button id="clear-canvas">Clear</button>
<button id="save-canvas">Save</button>
<button id="load-canvas">Load</button>
<button id="export-canvas">Export PNG</button>
</div>
</section>
</main>
</div>
<script>
// Firebase config
var FIREBASE_CONFIG = {
 apiKey: "AIzaSyCtnsy5Cbyi9XI6gGDAMNeXYDd5fL9KtU",
 authDomain: "nemeangames-family-hub.firebaseapp.com",
 projectId: "nemeangames-family-hub",
 storageBucket: "nemeangames-family-hub.appspot.com",
 messagingSenderId: "12189760130",
 appId: "1:12189760130:web:cfb25bad82f963a9623e2b"
};
firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.firestore();
firebase.auth().signInAnonymously().catch(function(err){console.log(err);});

// UI nav
document.querySelectorAll('nav button').forEach(btn=>{
 btn.addEventListener('click',function(){
   document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
   this.classList.add('active');
   document.querySelectorAll('main section').forEach(sec=>sec.classList.remove('active'));
   document.getElementById(this.getAttribute('data-target')).classList.add('active');
 });
});

// Username and color
var username = localStorage.getItem('3ds_username') || '';
var userColor = localStorage.getItem('3ds_user_color') || '#0066cc';
function refreshUserBar(){
 document.getElementById('display-user').textContent = 'User: '+username;
 document.getElementById('color-swatch').style.background = userColor;
 document.getElementById('user-bar').style.display = 'block';
}
function promptUser(){
 var name = prompt('Enter your display name:', username||'');
 if(name!==null){
   username = name.trim()||'Guest';
   localStorage.setItem('3ds_username', username);
 }
 var color = prompt('Enter a hex color (e.g., #0066cc):', userColor);
 if(color!==null && /^#([0-9A-F]{3}){1,2}$/i.test(color)){
   userColor = color;
   localStorage.setItem('3ds_user_color', userColor);
 }
 refreshUserBar();
}
if(!username){
 promptUser();
} else {
 refreshUserBar();
}
document.getElementById('change-user').addEventListener('click', promptUser);

// Chat functions
const ROOM_ID = 'family-room';
function sendMessage(text){
 if(!text) return;
 db.collection('rooms').doc(ROOM_ID).collection('messages').add({
   user: username,
   color: userColor,
   text: text,
   ts: firebase.firestore.FieldValue.serverTimestamp()
 });
}
function listenChat(){
 db.collection('rooms').doc(ROOM_ID).collection('messages').orderBy('ts').limit(200)
 .onSnapshot(function(snapshot){
   var msgs = document.getElementById('messages');
   msgs.innerHTML = '';
   snapshot.forEach(function(doc){
     var m = doc.data();
     var li = document.createElement('li');
     var time = m.ts ? m.ts.toDate().toLocaleTimeString() : '';
     li.textContent = '['+time+'] '+ (m.user||'Anon')+': '+ m.text;
     li.style.borderLeft = '6px solid '+(m.color||'#ccc');
     li.style.paddingLeft = '4px';
     msgs.appendChild(li);
   });
   msgs.scrollTop = msgs.scrollHeight;
 });
}
listenChat();
document.getElementById('send-btn').addEventListener('click', function(){
 var input = document.getElementById('chat-input');
 var text = input.value.trim();
 if(text){ sendMessage(text); input.value = ''; }
});
document.getElementById('chat-input').addEventListener('keydown', function(e){
 if(e.key==='Enter'){ e.preventDefault(); document.getElementById('send-btn').click(); }
});

// Tic-Tac-Toe
let tState, tTurn;
function initTic(){
 tState = Array(9).fill(null);
 tTurn = 'X';
 const board = document.getElementById('tictactoe-board');
 board.innerHTML = '';
 for(let i=0;i<3;i++){
   const row = document.createElement('tr');
   for(let j=0;j<3;j++){
     const cell = document.createElement('td');
     cell.textContent='';
     cell.addEventListener('click', function(){
       if(tState[i*3+j] || checkWin()) return;
       tState[i*3+j] = tTurn;
       cell.textContent = tTurn;
       if(checkWin()){
         document.getElementById('tic-status').textContent = 'Player '+tTurn+' wins!';
       } else if(tState.every(Boolean)){
         document.getElementById('tic-status').textContent = 'Draw!';
       } else {
         tTurn = tTurn==='X'?'O':'X';
         document.getElementById('tic-status').textContent = 'Player '+tTurn+"'s turn";
       }
     });
     row.appendChild(cell);
   }
   board.appendChild(row);
 }
 document.getElementById('tic-status').textContent = "Player X's turn";
}
function checkWin(){
 const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
 return lines.some(([a,b,c])=> tState[a] && tState[a]===tState[b] && tState[b]===tState[c]);
}
initTic();

// Rock-Paper-Scissors
document.querySelectorAll('.rps-btn').forEach(btn=>{
 btn.addEventListener('click', function(){
   const user = this.getAttribute('data-choice');
   const options = ['rock','paper','scissors'];
   const cpu = options[Math.floor(Math.random()*3)];
   let result;
   if(user===cpu) result='Draw';
   else if((user==='rock'&&cpu==='scissors')||(user==='paper'&&cpu==='rock')||(user==='scissors'&&cpu==='paper')) result='You win';
   else result='You lose';
   document.getElementById('rps-result').textContent = 'You: '+user+' CPU: '+cpu+' - '+result;
 });
});

// Calendar (local)
let calDate = new Date();
function renderCalendar(){
 const year = calDate.getFullYear();
 const month = calDate.getMonth();
 document.getElementById('cal-title').textContent = calDate.toLocaleString('default',{month:'long'})+' '+year;
 const table = document.getElementById('calendar-table');
 table.innerHTML = '';
 const firstDay = new Date(year,month,1).getDay();
 const daysInMonth = new Date(year,month+1,0).getDate();
 let tr = document.createElement('tr');
 // Weekday headers
 ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>{
   const th = document.createElement('th');
   th.textContent = d;
   tr.appendChild(th);
 });
 table.appendChild(tr);
 // cells
 tr = document.createElement('tr');
 for(let i=0;i<firstDay;i++){
   tr.appendChild(document.createElement('td'));
 }
 let day=1;
 for(let i=firstDay;i<7;i++){
   tr.appendChild(createDayCell(year, month, day++));
 }
 table.appendChild(tr);
 while(day<=daysInMonth){
   tr = document.createElement('tr');
   for(let i=0;i<7 && day<=daysInMonth;i++){
     tr.appendChild(createDayCell(year, month, day++));
   }
   table.appendChild(tr);
 }
}
function createDayCell(y,m,d){
 const td = document.createElement('td');
 td.textContent = d;
 const key = y+'-'+(m+1)+'-'+d;
 const note = localStorage.getItem('calNote-'+key);
 if(note){
   const span = document.createElement('span');
   span.className='event';
   span.textContent = note.substring(0,10);
   td.appendChild(span);
 }
 td.addEventListener('click', function(){
   const existing = localStorage.getItem('calNote-'+key) || '';
   const note = prompt('Enter note for '+key+':', existing);
   if(note!==null){
     if(note===''){ localStorage.removeItem('calNote-'+key); }
     else { localStorage.setItem('calNote-'+key, note); }
     renderCalendar();
   }
 });
 return td;
}
document.getElementById('prev-month').addEventListener('click', function(){
 calDate.setMonth(calDate.getMonth()-1);
 renderCalendar();
});
document.getElementById('next-month').addEventListener('click', function(){
 calDate.setMonth(calDate.getMonth()+1);
 renderCalendar();
});
renderCalendar();

// Notes
const noteArea = document.getElementById('notepad');
noteArea.value = localStorage.getItem('notepad') || '';
document.getElementById('save-note').addEventListener('click', function(){
 localStorage.setItem('notepad', noteArea.value);
 alert('Saved!');
});
document.getElementById('load-note').addEventListener('click', function(){
 noteArea.value = localStorage.getItem('notepad') || '';
 alert('Loaded!');
});

// Whiteboard
const wbCanvas = document.getElementById('whiteboard-canvas');
const wbCtx = wbCanvas.getContext('2d');
let drawing=false;
function startDraw(e){
 drawing=true;
 const rect = wbCanvas.getBoundingClientRect();
 const x = (e.clientX||e.touches[0].clientX) - rect.left;
 const y = (e.clientY||e.touches[0].clientY) - rect.top;
 wbCtx.beginPath();
 wbCtx.moveTo(x,y);
}
function moveDraw(e){
 if(!drawing) return;
 const rect = wbCanvas.getBoundingClientRect();
 const x = (e.clientX||e.touches[0].clientX) - rect.left;
 const y = (e.clientY||e.touches[0].clientY) - rect.top;
 wbCtx.lineTo(x,y);
 wbCtx.stroke();
}
function endDraw(){ drawing=false; saveCanvas(); }
wbCanvas.addEventListener('mousedown', startDraw);
wbCanvas.addEventListener('mousemove', moveDraw);
window.addEventListener('mouseup', endDraw);
wbCanvas.addEventListener('touchstart', function(e){e.preventDefault(); startDraw(e);});
wbCanvas.addEventListener('touchmove', function(e){e.preventDefault(); moveDraw(e);});
wbCanvas.addEventListener('touchend', function(e){e.preventDefault(); endDraw();});
function clearCanvas(){
 wbCtx.clearRect(0,0,wbCanvas.width, wbCanvas.height);
 saveCanvas();
}
function saveCanvas(){
 try{ localStorage.setItem('whiteboard', wbCanvas.toDataURL()); }catch(e){}
}
function loadCanvas(){
 try{
   const data = localStorage.getItem('whiteboard');
   if(data){
     const img = new Image();
     img.onload = function(){ wbCtx.clearRect(0,0,wbCanvas.width,wbCanvas.height); wbCtx.drawImage(img,0,0); };
     img.src = data;
   }
 }catch(e){}
}
function exportCanvas(){
 const data = wbCanvas.toDataURL('image/png');
 const a = document.createElement('a');
 a.href = data;
 a.download = 'drawing.png';
 a.click();
}
document.getElementById('clear-canvas').addEventListener('click', function(){ clearCanvas(); });
document.getElementById('save-canvas').addEventListener('click', function(){ saveCanvas(); alert('Saved'); });
document.getElementById('load-canvas').addEventListener('click', function(){ loadCanvas(); alert('Loaded'); });
document.getElementById('export-canvas').addEventListener('click', function(){ exportCanvas(); });
// load saved drawing
loadCanvas();
</script>
</body>
</html>
